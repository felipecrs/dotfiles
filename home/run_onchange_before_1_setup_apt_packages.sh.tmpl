#!/bin/bash

set -euo pipefail

echo "Installing apt packages"

{{ if not .is_devcontainer -}}
echo "Installing pre-requisites"
if ! sudo apt update; then
  echo "Ignoring failure because it may be due to ca-certificates"
fi
sudo apt install -y software-properties-common ca-certificates curl gnupg
echo "Setting up repositories"
sudo add-apt-repository --no-update -y ppa:git-core/ppa
docker_apt_repo="deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ .chezmoi.osRelease.ubuntuCodename }} stable"
# This ensures that the docker repo is not inside /etc/apt/sources.list
sudo add-apt-repository --no-update -y --remove "$docker_apt_repo"
echo "$docker_apt_repo" | sudo tee /etc/apt/sources.list.d/docker.list
unset docker_apt_repo
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
kubic_apt_repo="deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_{{ .chezmoi.osRelease.versionID }}/ /"
# This ensures that the kubic repo is not inside /etc/apt/sources.list
sudo add-apt-repository --no-update -y --remove "$kubic_apt_repo"
echo "$kubic_apt_repo" | sudo tee /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list
unset kubic_apt_repo
curl -fsSL https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_{{ .chezmoi.osRelease.versionID }}/Release.key | sudo apt-key add -
{{ if eq .chezmoi.osRelease.versionID "18.04" -}}
sudo add-apt-repository --no-update -y ppa:communitheme/ppa
{{ end -}}
{{ end -}}

readarray -t apt_packages <<'EOF'
zsh
direnv
{{ if not .is_devcontainer -}}
apt-transport-https
ca-certificates
gnupg
lsb-release
build-essential
curl
wget
tree
parallel
file
procps
zip
git
jq
crudini
docker-ce
docker-ce-cli
containerd.io
skopeo
asciinema
{{   if .is_gnome -}}
yaru-theme-gtk
yaru-theme-icon
yaru-theme-sound
gnome-tweaks
{{     if not .is_wsl -}}
yaru-theme-gnome-shell
libsecret-1-0
gnome-menus
{{     end -}}
{{   end -}}
{{   if not .is_wsl -}}
{{     if eq .chezmoi.osRelease.versionID "18.04" -}}
linux-generic-hwe-18.04
{{     else if eq .chezmoi.osRelease.versionID "20.04" -}}
linux-generic-hwe-20.04
{{     end -}}
{{   end -}}
{{ end -}}
EOF

# Only install if not already installed to save some time
echo "Installing packages"
sudo apt update

sudo apt install -y "${apt_packages[@]}"

{{ if not .is_devcontainer -}}
echo "Configuring Docker"
sudo usermod -aG docker "{{ .chezmoi.username }}"
if [[ ! -f /etc/docker/daemon.json ]]; then
  sudo mkdir -p /etc/docker
  echo '{}' | sudo tee /etc/docker/daemon.json >/dev/null
fi
jq --raw-output '.features.buildkit = true' /etc/docker/daemon.json | tee /tmp/daemon.json >/dev/null && sudo mv -f /tmp/daemon.json /etc/docker/daemon.json

echo "Installing compose-switch (docker-compose v1 compatibility)"
{{   $composeSwitchVersion := output "curl" "-fsSL" "-o" "/dev/null" "-w" "%{url_effective}" "https://github.com/docker/compose-switch/releases/latest" | trim | base -}}
sudo curl -fsSL "https://github.com/docker/compose-switch/releases/download/{{ $composeSwitchVersion }}/docker-compose-linux-amd64" --output /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

{{ if .is_wsl -}}
echo "Setting up docker service in WSL initalization"
sudo crudini --set /etc/wsl.conf boot command '"service docker start"'
{{   $dockerCredsVersion := output "curl" "-fsSL" "-o" "/dev/null" "-w" "%{url_effective}" "https://github.com/docker/docker-credential-helpers/releases/latest" | trim | base -}}
echo "Installing docker credential helper for WSL"
curl -fsSL "https://github.com/docker/docker-credential-helpers/releases/download/{{ $dockerCredsVersion }}/docker-credential-wincred-{{ $dockerCredsVersion }}-amd64.zip" | zcat | sudo tee /usr/bin/docker-credential-wincred.exe >/dev/null
sudo chmod +x /usr/bin/docker-credential-wincred.exe
{{ else if .is_gnome -}}
{{   $dockerCredsVersion := output "curl" "-fsSL" "-o" "/dev/null" "-w" "%{url_effective}" "https://github.com/docker/docker-credential-helpers/releases/latest" | trim | base -}}
echo "Installing docker credential helper for GNOME"
curl -fsSL "https://github.com/docker/docker-credential-helpers/releases/download/{{ $dockerCredsVersion }}/docker-credential-secretservice-{{ $dockerCredsVersion }}-amd64.tar.gz" | tar -xzf - -O | sudo tee /usr/bin/docker-credential-secretservice >/dev/null
sudo chmod +x /usr/bin/docker-credential-secretservice
{{- end }}

{{ if not .is_wsl | and .is_gnome | and (not (lookPath "git-credential-manager-core")) -}}
echo "Installing Git Credential Manager Core"
# Using this method while https://github.com/microsoft/Git-Credential-Manager-Core/issues/422 does not get solved
curl -fsSL 'https://glare.now.sh/microsoft/Git-Credential-Manager-Core/^.*.deb$' --output /tmp/gcmcore.deb
sudo apt install -y /tmp/gcmcore.deb
rm -f /tmp/gcmcore.deb
{{ end -}}

{{ if not .is_wsl | and .is_gnome | and (not (lookPath "google-chrome")) -}}
echo "Installing Google Chrome"
curl -fsSL 'https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb' --output /tmp/google-chrome.deb
sudo apt install -y /tmp/google-chrome.deb
rm -f /tmp/google-chrome.deb
{{ end -}}

{{/* checks if code shim is not the only vscode installed, or if it is running in a remote session */}}
{{ if not .is_wsl | and .is_gnome | and (not (output "bash" "-c" "which -a code | grep -v ~/.local/bin/code | grep -v ~/.vscode-server/ || true")) -}}
echo "Installing VS Code"
curl -fsSL 'https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64' --output /tmp/code.deb
sudo apt install -y /tmp/code.deb
rm -f /tmp/code.deb
{{ end -}}

{{ end -}}
